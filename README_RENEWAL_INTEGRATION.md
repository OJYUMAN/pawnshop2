# ฟีเจอร์การรวมข้อมูลการต่อดอกในระบบ

## ภาพรวม

ฟีเจอร์นี้เพิ่มความสามารถในการจัดการข้อมูลการต่อดอกเมื่อสร้างใบฝากขาย โดยจะแสดงข้อมูลการต่อดอกใน PDF และอนุญาตให้ผู้ใช้บันทึกข้อมูลการต่อดอกได้

## ฟีเจอร์ที่เพิ่มเข้ามา

### 1. Tab ข้อมูลการต่อดอกในฟอร์มสร้างสัญญา

- **จำนวนวันฝากนับถึงปัจจุบัน**: แสดงจำนวนวันที่ฝากสินค้า
- **ต่อดอกครั้งที่**: ระบุลำดับการต่อดอก
- **ค่าธรรมเนียมต่อดอก**: จำนวนเงินค่าธรรมเนียม
- **ค่าปรับ**: จำนวนเงินค่าปรับ (ถ้ามี)
- **ส่วนลด**: จำนวนเงินส่วนลด (ถ้ามี)
- **รวม**: ยอดรวมการต่อดอก
- **วันต่อดอก**: วันที่ทำการต่อดอก
- **วันครบกำหนดปัจจุบัน**: วันครบกำหนดก่อนต่อดอก
- **วันครบกำหนดใหม่**: วันครบกำหนดหลังต่อดอก
- **จำนวนวันต่อดอก**: จำนวนวันที่ขยายออกไป

### 2. การแสดงข้อมูลการต่อดอกใน PDF

- แสดงข้อมูลการต่อดอกในส่วนข้อมูลการเงิน
- เพิ่มเงื่อนไขการต่อดอกในส่วนเงื่อนไขสำคัญ
- แสดงประวัติการต่อดอกทั้งหมด

### 3. การบันทึกข้อมูลการต่อดอก

- บันทึกข้อมูลการต่อดอกพร้อมกับสัญญา
- อัพเดทวันที่ครบกำหนดอัตโนมัติ
- คำนวณยอดรวมการต่อดอก

## การใช้งาน

### ขั้นตอนการสร้างสัญญาพร้อมข้อมูลการต่อดอก

1. เปิดฟอร์ม "เพิ่มสัญญาใหม่"
2. กรอกข้อมูลสัญญาใน Tab "ข้อมูลสัญญา"
3. เลือกลูกค้าใน Tab "ข้อมูลลูกค้า"
4. เลือกสินค้าใน Tab "ข้อมูลสินค้า"
5. กรอกข้อมูลการต่อดอกใน Tab "ข้อมูลการต่อดอก":
   - ระบุค่าธรรมเนียมต่อดอก
   - ระบุค่าปรับ (ถ้ามี)
   - ระบุส่วนลด (ถ้ามี)
   - ระบุจำนวนวันต่อดอก
6. กดปุ่ม "บันทึกสัญญา"

### การสร้างใบฝากขายพร้อมข้อมูลการต่อดอก

1. เลือกสัญญาที่ต้องการสร้างใบฝากขาย
2. กดปุ่ม "สร้างใบขายฝาก"
3. เลือกตำแหน่งบันทึกไฟล์ PDF
4. ระบบจะสร้าง PDF พร้อมข้อมูลการต่อดอก

## โครงสร้างข้อมูล

### ตาราง renewals

```sql
CREATE TABLE IF NOT EXISTS renewals (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    contract_id INTEGER NOT NULL,
    contract_number TEXT NOT NULL,
    renewal_count INTEGER NOT NULL,
    fee_amount REAL DEFAULT 0,
    penalty_amount REAL DEFAULT 0,
    discount_amount REAL DEFAULT 0,
    total_amount REAL DEFAULT 0,
    renewal_date DATE NOT NULL,
    current_due_date DATE NOT NULL,
    new_due_date DATE NOT NULL,
    extension_days INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (contract_id) REFERENCES contracts (id)
);
```

### ข้อมูลการต่อดอกใน PDF

```python
renewal_data = [
    {
        'renewal_date': '2024-02-01',
        'renewal_days': 30,
        'renewal_rate': 2.5
    }
]
```

## การทดสอบ

### ทดสอบการสร้าง PDF

```bash
python test_renewal_integration.py
```

### ทดสอบฐานข้อมูล

```bash
python test_renewal_integration.py
```

## การปรับแต่ง

### เปลี่ยนอัตราดอกเบี้ยการต่อดอก

แก้ไขในฟังก์ชัน `generate_pawn_ticket_from_data` ในไฟล์ `pdf.py`:

```python
renewal_rate = renewal.get('renewal_rate', 0)
if renewal_rate > 0:
    renewal_interest_amount = (pawn_amount * renewal_rate * renewal_days) / 36500
```

### เพิ่มฟิลด์ใหม่ในการต่อดอก

1. เพิ่มฟิลด์ในฟอร์ม `create_renewal_tab`
2. เพิ่มฟิลด์ในฟังก์ชัน `save_renewal`
3. อัพเดทฐานข้อมูล
4. แสดงผลใน PDF

## ข้อควรระวัง

1. **ข้อมูลการต่อดอก**: ต้องบันทึกข้อมูลการต่อดอกก่อนสร้างสัญญา
2. **วันที่**: วันที่ต่อดอกต้องไม่เกินวันที่ครบกำหนดปัจจุบัน
3. **การคำนวณ**: ยอดรวมการต่อดอกจะคำนวณอัตโนมัติ
4. **ฐานข้อมูล**: ต้องมีตาราง `renewals` ในฐานข้อมูล

## การแก้ไขปัญหา

### ปัญหาที่พบบ่อย

1. **ไม่แสดงข้อมูลการต่อดอกใน PDF**
   - ตรวจสอบว่ามีข้อมูลการต่อดอกในฐานข้อมูล
   - ตรวจสอบการส่งพารามิเตอร์ `renewal_data`

2. **ข้อผิดพลาดในการบันทึกการต่อดอก**
   - ตรวจสอบว่าสร้างสัญญาก่อนแล้ว
   - ตรวจสอบการเชื่อมต่อฐานข้อมูล

3. **ไม่แสดง Tab ข้อมูลการต่อดอก**
   - ตรวจสอบการสร้าง UI ใน `create_renewal_tab`
   - ตรวจสอบการเพิ่ม Tab ใน `setup_ui`

### การ Debug

เพิ่ม logging ในฟังก์ชันหลัก:

```python
import logging
logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)

def generate_pawn_ticket_from_data(...):
    logger.debug(f"renewal_data: {renewal_data}")
    # ... rest of the function
```

## การพัฒนาต่อ

### ฟีเจอร์ที่อาจเพิ่มในอนาคต

1. **การต่อดอกอัตโนมัติ**: ต่อดอกเมื่อครบกำหนดโดยอัตโนมัติ
2. **การแจ้งเตือน**: แจ้งเตือนเมื่อใกล้ครบกำหนด
3. **รายงานการต่อดอก**: สร้างรายงานสรุปการต่อดอก
4. **การต่อดอกหลายครั้ง**: ต่อดอกหลายครั้งพร้อมกัน
5. **การคำนวณดอกเบี้ยทบต้น**: คำนวณดอกเบี้ยทบต้นในการต่อดอก

## สรุป

ฟีเจอร์การรวมข้อมูลการต่อดอกช่วยให้ระบบจัดการข้อมูลการต่อดอกได้อย่างครบถ้วน และแสดงผลในใบฝากขายได้อย่างชัดเจน ผู้ใช้สามารถบันทึกข้อมูลการต่อดอกได้ตั้งแต่ขั้นตอนการสร้างสัญญา และข้อมูลจะถูกแสดงใน PDF อัตโนมัติ

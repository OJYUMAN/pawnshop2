# การแก้ไขปัญหา UNIQUE constraint failed: customers.customer_code

## ปัญหาที่เกิดขึ้น
เมื่อพยายามเพิ่มลูกค้าใหม่ ระบบแสดงข้อผิดพลาด:
```
เกิดข้อผิดพลาดในการเพิ่มลูกค้า: UNIQUE constraint failed: customers.customer_code
```

## สาเหตุของปัญหา
1. **ฟังก์ชัน `get_next_customer_sequence` ไม่มีอยู่**: ใน `main.py` เรียกใช้ฟังก์ชันที่ไม่มีอยู่ใน `database.py`
2. **การตรวจสอบความซ้ำซ้อนไม่ครบถ้วน**: ไม่มีการตรวจสอบรหัสลูกค้าซ้ำซ้อนก่อนการเพิ่มข้อมูล
3. **การจัดการข้อผิดพลาดไม่เหมาะสม**: ไม่มีการแยกประเภทข้อผิดพลาดระหว่างข้อมูลซ้ำซ้อนและข้อผิดพลาดอื่นๆ

## การแก้ไขที่ดำเนินการ

### 1. แก้ไขฟังก์ชัน `generate_new_customer_code` ใน `main.py`
- เปลี่ยนจากการเรียกใช้ `get_next_customer_sequence` เป็น `get_next_customer_code`
- เพิ่มการจัดการข้อผิดพลาดเมื่อไม่มี prefix ในฐานข้อมูล

### 2. เพิ่มการตรวจสอบความซ้ำซ้อนใน `save_new_customer`
- ตรวจสอบรหัสลูกค้าซ้ำซ้อนก่อนการเพิ่มข้อมูล
- ตรวจสอบเลขบัตรประชาชนซ้ำซ้อน
- แสดงข้อความแจ้งเตือนที่เหมาะสม

### 3. ปรับปรุงฟังก์ชัน `add_customer` ใน `database.py`
- เพิ่มการตรวจสอบความซ้ำซ้อนในระดับฐานข้อมูล
- แยกประเภทข้อผิดพลาดระหว่างข้อมูลซ้ำซ้อนและข้อผิดพลาดอื่นๆ

### 4. เพิ่มค่าเริ่มต้น `customer_prefix` ในฐานข้อมูล
- เพิ่ม `customer_prefix` ใน default settings
- ใช้ค่าเริ่มต้น "C" ถ้าไม่มีในฐานข้อมูล

### 5. เพิ่มฟังก์ชันแก้ไขข้อมูลซ้ำซ้อน
- `fix_duplicate_customer_codes()`: แก้ไขปัญหารหัสลูกค้าซ้ำซ้อน
- `fix_duplicate_id_cards()`: แก้ไขปัญหาเลขบัตรประชาชนซ้ำซ้อน
- เพิ่มเมนู "จัดการฐานข้อมูล" ในเมนูหลัก

## วิธีการใช้งาน

### การเพิ่มลูกค้าใหม่
1. คลิก "เพิ่มลูกค้า" หรือใช้เมนู "ลูกค้า" > "เพิ่มลูกค้า"
2. ระบบจะสร้างรหัสลูกค้าใหม่อัตโนมัติ
3. กรอกข้อมูลลูกค้า
4. คลิก "บันทึก"

### การแก้ไขข้อมูลซ้ำซ้อน
1. ใช้เมนู "จัดการฐานข้อมูล" > "แก้ไขข้อมูลซ้ำซ้อน"
2. ระบบจะตรวจสอบและแก้ไขปัญหาข้อมูลซ้ำซ้อนอัตโนมัติ
3. แสดงผลการแก้ไข

## การป้องกันปัญหาในอนาคต
1. **การตรวจสอบอัตโนมัติ**: ระบบตรวจสอบความซ้ำซ้อนก่อนการเพิ่มข้อมูล
2. **การสร้างรหัสอัตโนมัติ**: ระบบสร้างรหัสลูกค้าใหม่อัตโนมัติโดยไม่ซ้ำซ้อน
3. **การจัดการข้อผิดพลาด**: แยกประเภทข้อผิดพลาดและแสดงข้อความที่เหมาะสม

## หมายเหตุ
- การแก้ไขข้อมูลซ้ำซ้อนจะเปลี่ยนรหัสลูกค้าที่ซ้ำเป็นรูปแบบ `รหัสเดิม-ลำดับ` (เช่น C0001-01)
- การแก้ไขเลขบัตรประชาชนซ้ำจะลบเลขบัตรของรายการที่ซ้ำออก
- ข้อมูลที่ถูกแก้ไขจะไม่สูญหาย แต่จะถูกปรับให้ไม่ซ้ำซ้อน

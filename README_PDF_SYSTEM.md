# ระบบสร้างใบขายฝาก PDF

ระบบสร้างใบขายฝาก PDF ที่ปรับเนื้อหาให้ตรงตามสัญญา โดยใช้ format เหมือน `pdf.py` และให้เลือก save ได้

## คุณสมบัติ

- ✅ สร้างใบขายฝาก PDF จากข้อมูลสัญญาในฐานข้อมูล
- ✅ ใช้ format และฟอนต์ภาษาไทยเหมือน `pdf.py`
- ✅ ปรับเนื้อหาให้ตรงตามสัญญา (ชื่อลูกค้า, สินค้า, ยอดเงิน, วันที่, ฯลฯ)
- ✅ เลือกตำแหน่งที่จะบันทึกไฟล์ได้
- ✅ เปิดไฟล์ PDF อัตโนมัติหลังจากสร้างเสร็จ
- ✅ รองรับการสร้าง PDF จากสัญญาใหม่และสัญญาที่มีอยู่แล้ว

## ไฟล์ที่เกี่ยวข้อง

### 1. `contract_pdf_generator.py`
คลาสหลักสำหรับสร้างใบขายฝาก PDF

**คุณสมบัติ:**
- `ContractPDFGenerator`: คลาสหลักสำหรับสร้าง PDF
- `generate_contract_pdf()`: สร้าง PDF จาก contract_id
- `select_save_location()`: ให้ผู้ใช้เลือกตำแหน่งที่จะบันทึก

**การใช้งาน:**
```python
from contract_pdf_generator import ContractPDFGenerator

# สร้าง PDF Generator
generator = ContractPDFGenerator()

# สร้าง PDF และให้เลือกตำแหน่งที่จะบันทึก
result_path = generator.generate_contract_pdf(contract_id)

# หรือระบุตำแหน่งที่จะบันทึกเอง
result_path = generator.generate_contract_pdf(contract_id, "path/to/output.pdf")
```

### 2. `contract_pdf_dialog.py`
หน้าต่างสำหรับสร้าง PDF จากสัญญาที่มีอยู่แล้ว

**คุณสมบัติ:**
- แสดงรายการสัญญาทั้งหมด
- ค้นหาสัญญาตามเลขที่สัญญาหรือชื่อลูกค้า
- เลือกสัญญาที่ต้องการสร้าง PDF
- เลือกตำแหน่งที่จะบันทึก

**การใช้งาน:**
```python
from contract_pdf_dialog import show_contract_pdf_dialog

# แสดงหน้าต่างสร้าง PDF
show_contract_pdf_dialog(parent_window)
```

### 3. `contract_form.py` (ปรับปรุงแล้ว)
เพิ่มปุ่มสร้าง PDF หลังจากบันทึกสัญญาใหม่

**คุณสมบัติใหม่:**
- ปุ่ม "สร้าง PDF" หลังจากบันทึกสัญญา
- สร้าง PDF จากสัญญาที่เพิ่งบันทึก
- เลือกตำแหน่งที่จะบันทึก

## วิธีการใช้งาน

### วิธีที่ 1: สร้าง PDF จากสัญญาใหม่

1. เปิดหน้าต่าง "เพิ่มสัญญาใหม่"
2. กรอกข้อมูลสัญญา ลูกค้า และสินค้า
3. กดปุ่ม "บันทึกสัญญา"
4. หลังจากบันทึกสำเร็จ ปุ่ม "สร้าง PDF" จะเปิดใช้งานได้
5. กดปุ่ม "สร้าง PDF"
6. เลือกตำแหน่งที่จะบันทึกไฟล์
7. ระบบจะสร้าง PDF และเปิดไฟล์ให้ดูอัตโนมัติ

### วิธีที่ 2: สร้าง PDF จากสัญญาที่มีอยู่แล้ว

1. ไปที่เมนู "รายงาน" → "สร้างใบขายฝาก PDF"
2. เลือกสัญญาที่ต้องการสร้าง PDF
3. กดปุ่ม "สร้าง PDF"
4. เลือกตำแหน่งที่จะบันทึกไฟล์
5. ระบบจะสร้าง PDF และเปิดไฟล์ให้ดูอัตโนมัติ

## รูปแบบ PDF ที่สร้าง

PDF ที่สร้างจะมีรูปแบบดังนี้:

### ส่วนหัว
- หัวข้อ "ใบขายฝาก"
- ชื่อร้านและที่อยู่

### ข้อมูลสัญญา
- เลขที่สัญญา
- วันที่เริ่มต้น

### ข้อมูลลูกค้า
- ชื่อ-นามสกุล
- เบอร์โทรศัพท์
- ที่อยู่
- เลขบัตรประชาชน

### ข้อมูลสินค้า
- ชื่อสินค้าและยี่ห้อ
- ยอดฝาก
- ค่าดำเนินการ
- ค่าธรรมเนียม (ถ้ามี)

### เงื่อนไขและข้อตกลง
- เงื่อนไขการขายฝาก 3 ข้อ

### หมายเหตุ
- ข้อกำหนดพิเศษ

### ข้อมูลการไถ่ถอน
- ยอดไถ่ถอน
- กำหนดไถ่ทรัพย์สิน

### ลายเซ็น
- ลายเซ็นผู้รับฝาก
- ลายเซ็นผู้ขายฝาก

## ข้อกำหนดระบบ

### ฟอนต์ภาษาไทย
ต้องมีไฟล์ฟอนต์ต่อไปนี้ในโฟลเดอร์โปรเจค:
- `THSarabun.ttf`
- `THSarabun Bold.ttf`

### Dependencies
```python
reportlab  # สำหรับสร้าง PDF
PySide6    # สำหรับ GUI
```

## การแก้ไขปัญหา

### ปัญหาที่พบบ่อย

1. **ไม่พบไฟล์ฟอนต์**
   - ตรวจสอบว่ามีไฟล์ `THSarabun.ttf` และ `THSarabun Bold.ttf` ในโฟลเดอร์โปรเจค

2. **ไม่สามารถสร้าง PDF ได้**
   - ตรวจสอบว่าสัญญามีข้อมูลครบถ้วน
   - ตรวจสอบสิทธิ์การเขียนไฟล์ในโฟลเดอร์ที่เลือก

3. **PDF ไม่แสดงภาษาไทย**
   - ตรวจสอบการโหลดฟอนต์
   - ตรวจสอบเวอร์ชันของ reportlab

### การ Debug

เพิ่ม logging เพื่อดูการทำงาน:
```python
import logging
logging.basicConfig(level=logging.DEBUG)

# ใน ContractPDFGenerator
logging.debug(f"Creating PDF for contract: {contract_id}")
```

## การปรับแต่งเพิ่มเติม

### เพิ่มฟิลด์ใหม่ใน PDF
แก้ไขฟังก์ชันที่เกี่ยวข้องใน `ContractPDFGenerator`:

```python
def _draw_custom_field(self, c, data, width, y_pos):
    """วาดฟิลด์ที่เพิ่มใหม่"""
    # เพิ่มโค้ดสำหรับฟิลด์ใหม่
    pass
```

### เปลี่ยนรูปแบบ PDF
แก้ไขฟังก์ชัน `_create_pdf()` เพื่อปรับลำดับและรูปแบบ:

```python
def _create_pdf(self, contract_data, customer_data, product_data, output_path):
    # ปรับลำดับการวาดส่วนต่างๆ
    # เพิ่มส่วนใหม่
    # เปลี่ยนรูปแบบ
    pass
```

## การทดสอบ

### ทดสอบการสร้าง PDF
```bash
# ทดสอบ ContractPDFGenerator โดยตรง
python contract_pdf_generator.py

# ทดสอบ ContractPDFDialog
python contract_pdf_dialog.py
```

### ทดสอบการทำงานในระบบหลัก
1. รันโปรแกรมหลัก
2. สร้างสัญญาใหม่
3. ทดสอบการสร้าง PDF
4. เปิดเมนูสร้าง PDF จากสัญญาที่มีอยู่

## การอัปเดต

เมื่อมีการเปลี่ยนแปลงโครงสร้างฐานข้อมูล ให้อัปเดตฟังก์ชันที่เกี่ยวข้องใน `ContractPDFGenerator` เพื่อให้ตรงกับโครงสร้างใหม่

## สนับสนุน

หากพบปัญหาหรือต้องการความช่วยเหลือ กรุณาตรวจสอบ:
1. Log files
2. ข้อความ error ที่แสดง
3. การตั้งค่าระบบ
4. Dependencies และเวอร์ชัน


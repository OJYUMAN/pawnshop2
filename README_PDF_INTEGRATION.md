# ระบบ PDF ใบขายฝากที่เชื่อมต่อกับระบบหลัก

## ภาพรวม

ระบบ PDF ใบขายฝากได้ถูกปรับปรุงให้สามารถดึงข้อมูลจริงจากระบบหลักและสร้าง PDF ที่มีข้อมูลครบถ้วนและถูกต้อง โดยใช้ฟอนต์ภาษาไทย THSarabun เพื่อให้เอกสารดูสวยงามและเป็นทางการ

## คุณสมบัติหลัก

### 1. การสร้าง PDF จากข้อมูลจริง
- ดึงข้อมูลลูกค้าจากฐานข้อมูล (ชื่อ, ที่อยู่, เบอร์โทร, เลขบัตรประชาชน)
- ดึงข้อมูลสินค้าจากฐานข้อมูล (ชื่อ, ยี่ห้อ, รายละเอียด)
- ดึงข้อมูลสัญญาจากระบบ (ยอดฝาก, อัตราดอกเบี้ย, ค่าธรรมเนียม, วันที่)

### 2. การแสดงผลภาษาไทย
- ใช้ฟอนต์ THSarabun และ THSarabun Bold
- แปลงวันที่เป็นภาษาไทย (เดือนภาษาไทย)
- รองรับการแสดงผลภาษาไทยอย่างถูกต้อง

### 3. การเชื่อมต่อกับระบบหลัก
- เรียกใช้จากปุ่ม "สร้างใบขายฝาก" ใน toolbar
- แสดง dialog หลังจากบันทึกสัญญาเพื่อสร้าง PDF
- มีระบบ fallback ไปใช้วิธีเดิมถ้าเกิดข้อผิดพลาด

## การใช้งาน

### 1. สร้าง PDF จากปุ่มใน Toolbar
1. เลือกลูกค้าและสินค้า
2. กรอกข้อมูลสัญญา
3. คลิกปุ่ม "สร้างใบขายฝาก" ใน toolbar
4. เลือกตำแหน่งที่จะบันทึกไฟล์ PDF
5. ระบบจะสร้าง PDF ที่มีข้อมูลครบถ้วน

### 2. สร้าง PDF หลังจากบันทึกสัญญา
1. กรอกข้อมูลสัญญาและบันทึก
2. ระบบจะแสดง dialog ถามว่าต้องการสร้าง PDF หรือไม่
3. คลิก "ใช่" เพื่อสร้าง PDF
4. เลือกตำแหน่งที่จะบันทึกไฟล์

### 3. การสร้าง PDF แบบโปรแกรม
```python
from pdf import generate_pawn_ticket_from_data

# สร้างข้อมูลสัญญา
contract_data = {
    'contract_number': 'CN-2024-001',
    'start_date': '2024-01-15',
    'end_date': '2024-02-15',
    'days_count': 30,
    'pawn_amount': 5000.00,
    'interest_rate': 15.0,
    'fee_amount': 100.00,
    'withholding_tax_rate': 3.0,
    'withholding_tax_amount': 75.00,
    'total_paid': 4925.00,
    'total_redemption': 5175.00
}

# สร้างข้อมูลลูกค้า
customer_data = {
    'first_name': 'สมชาย',
    'last_name': 'ใจดี',
    'id_card': '1234567890123',
    'phone': '0812345678',
    'house_number': '123',
    'street': 'ถนนสุขุมวิท',
    'subdistrict': 'คลองเตย',
    'district': 'คลองเตย',
    'province': 'กรุงเทพมหานคร'
}

# สร้างข้อมูลสินค้า
product_data = {
    'name': 'iPhone 14',
    'brand': 'Apple',
    'size': '6.1 inch',
    'weight': 172.0,
    'weight_unit': 'g',
    'serial_number': 'ABC123456789',
    'other_details': 'สีน้ำเงิน 128GB'
}

# สร้าง PDF
result = generate_pawn_ticket_from_data(
    contract_data=contract_data,
    customer_data=customer_data,
    product_data=product_data,
    output_file="pawn_ticket.pdf"
)
```

## โครงสร้างไฟล์

### ไฟล์หลัก
- `pdf.py` - ฟังก์ชันสร้าง PDF หลัก
- `main.py` - ระบบหลักที่เชื่อมต่อกับ PDF
- `test_pdf_integration.py` - ไฟล์ทดสอบการทำงาน

### ฟังก์ชันใน pdf.py
- `generate_pawn_ticket()` - ฟังก์ชันเดิมสำหรับสร้าง PDF ตัวอย่าง
- `generate_pawn_ticket_from_data()` - ฟังก์ชันใหม่สำหรับสร้าง PDF จากข้อมูลจริง

### ฟังก์ชันใน main.py
- `generate_pawn_contract_pdf()` - ปุ่มสร้าง PDF ใน toolbar
- `_create_pawn_contract_pdf()` - ฟังก์ชันสร้าง PDF ที่ใช้ pdf.py
- `show_pdf_generation_dialog()` - แสดง dialog หลังจากบันทึกสัญญา

## การทดสอบ

### 1. ทดสอบการสร้าง PDF
```bash
python test_pdf_integration.py
```

### 2. ทดสอบการทำงานในระบบหลัก
1. รันระบบหลัก: `python main.py`
2. เลือกลูกค้าและสินค้า
3. กรอกข้อมูลสัญญา
4. คลิกปุ่ม "สร้างใบขายฝาก" หรือบันทึกสัญญาแล้วสร้าง PDF

## ข้อกำหนด

### 1. ไฟล์ฟอนต์
- `THSarabun.ttf` - ฟอนต์ปกติ
- `THSarabun Bold.ttf` - ฟอนต์หนา

### 2. Dependencies
- `reportlab` - สำหรับสร้าง PDF
- `PySide6` - สำหรับ UI

### 3. โครงสร้างฐานข้อมูล
- ตาราง `customers` - ข้อมูลลูกค้า
- ตาราง `products` - ข้อมูลสินค้า
- ตาราง `contracts` - ข้อมูลสัญญา

## การแก้ไขปัญหา

### 1. ฟอนต์ไม่พบ
```
Error: Font file not found.
Please make sure 'THSarabun.ttf' and 'THSarabun Bold.ttf' are in the same folder as the script.
```
**วิธีแก้**: ตรวจสอบว่าไฟล์ฟอนต์อยู่ในโฟลเดอร์เดียวกับ `pdf.py`

### 2. ไม่สามารถสร้าง PDF ได้
- ตรวจสอบว่า `reportlab` ติดตั้งแล้ว
- ตรวจสอบสิทธิ์การเขียนไฟล์ในโฟลเดอร์ปลายทาง
- ตรวจสอบข้อมูลที่ส่งเข้าไปว่าครบถ้วนหรือไม่

### 3. ข้อมูลแสดงไม่ถูกต้อง
- ตรวจสอบโครงสร้างข้อมูลที่ส่งเข้าไป
- ตรวจสอบว่าข้อมูลในฐานข้อมูลครบถ้วนหรือไม่
- ตรวจสอบการแปลงวันที่และตัวเลข

## การปรับแต่ง

### 1. เปลี่ยนฟอนต์
แก้ไขใน `pdf.py`:
```python
font_path = 'path/to/your/font.ttf'
bold_font_path = 'path/to/your/bold-font.ttf'
```

### 2. เปลี่ยนรูปแบบวันที่
แก้ไขใน `pdf.py` ในส่วน `month_map`:
```python
month_map = {
    'January': 'มกราคม',
    'February': 'กุมภาพันธ์',
    # ... เพิ่มเดือนอื่นๆ
}
```

### 3. เปลี่ยนข้อความในเอกสาร
แก้ไขใน `pdf.py` ในส่วน `text_terms` และ `note_lines`

## การพัฒนาต่อ

### 1. เพิ่มฟิลด์ข้อมูล
- เพิ่มข้อมูลลูกค้า (เช่น อีเมล, อาชีพ)
- เพิ่มข้อมูลสินค้า (เช่น รูปภาพ, เอกสารแนบ)
- เพิ่มข้อมูลสัญญา (เช่น เงื่อนไขพิเศษ, หมายเหตุ)

### 2. ปรับปรุงการแสดงผล
- เพิ่ม QR Code สำหรับข้อมูลสัญญา
- เพิ่มลายน้ำหรือตราประทับ
- ปรับแต่งสีและรูปแบบ

### 3. เพิ่มฟังก์ชัน
- ส่ง PDF ทางอีเมล
- อัปโหลด PDF ไปยัง Cloud Storage
- สร้าง PDF แบบ Batch สำหรับหลายสัญญา

## สรุป

ระบบ PDF ใบขายฝากได้ถูกปรับปรุงให้สามารถดึงข้อมูลจริงจากระบบหลักและสร้างเอกสารที่มีข้อมูลครบถ้วน ถูกต้อง และสวยงาม โดยใช้ฟอนต์ภาษาไทยที่เหมาะสม ระบบมีทั้งการใช้งานผ่าน UI และการเรียกใช้แบบโปรแกรม พร้อมระบบ fallback เพื่อความเสถียรในการทำงาน
